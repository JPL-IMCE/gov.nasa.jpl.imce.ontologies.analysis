#!/BIN/sh

CATALOG=oml.catalog.xml
CONVERT=$HOME/Downloads/OMLConverters/bin/omlConverter
INPUT=oml-input
OUTPUT=ontologies
PUBLIC=$HOME/git/gov.nasa.jpl.imce.ontologies.public
PUBLIC_BUNDLES=$PUBLIC/bundles
IMCE=imce.jpl.nasa.gov
PROJECT_BUNDLE_PATH=$IMCE/foundation/project
EUROPA=europa.jpl.nasa.gov
OMG_ORG=www.omg.org
OMIT='
  imce.jpl.nasa.gov/discipline/mechanical
  imce.jpl.nasa.gov/discipline/ontological-behavior
  imce.jpl.nasa.gov/discipline/risk
  imce.jpl.nasa.gov/discipline/state-analysis
  imce.jpl.nasa.gov/math
  imce.jpl.nasa.gov/skeleton
  imce.jpl.nasa.gov/time
  imce.jpl.nasa.gov/www.omg.org
'

# run in analysis target/workflow/artifacts

if [ $(expr "$PWD" : '.*target\/workflow\/artifacts$') -eq 0 ]
then
  echo "must run in .../target/workflow/artifacts" 1>&2
  exit 1
fi

# unzip exported data

mkdir -p $INPUT
(cd $INPUT; unzip $1)

# remove unneeded ontologies

for o in $OMIT
do
    rm -rf $INPUT/$o
done
find $INPUT -type f -name '*-embedding.oml' -print0 | xargs -0 rm -f

# remove bogus vocabulary extensions

for o in $(find $INPUT -name '*.oml')
do 
    sed -i.bak '/extends.*owl2-mof2/d' $o
done

# convert OML to owl

$CONVERT text $INPUT/$CATALOG --output $OUTPUT --owl --clear

# add cached project bundle

mkdir -p $OUTPUT/$PROJECT_BUNDLE_PATH
rsync -av --exclude='**-embedding*' $PUBLIC_BUNDLES/$PROJECT_BUNDLE_PATH/ $OUTPUT/$PROJECT_BUNDLE_PATH
