#!/BIN/sh

CATALOG=oml.catalog.xml
CONVERT=$HOME/Downloads/OMLConverters/bin/omlConverter
INPUT=oml-input
OUTPUT=ontologies
PUBLIC=$HOME/git/gov.nasa.jpl.imce.ontologies.public
PUBLIC_OML=$PUBLIC/converted-oml
PUBLIC_OWL=$PUBLIC/ontologies
PUBLIC_BUNDLES=$PUBLIC/bundles
IMCE=imce.jpl.nasa.gov
PROJECT_BUNDLE_PATH=$IMCE/foundation/project
PURL_ORG=purl.org
PURL_ORG_OML=$PUBLIC_OML/$PURL_ORG
PURL_ORG_OWL=$PUBLIC_OWL/$PURL_ORG
EUROPA=europa.jpl.nasa.gov
OMG_ORG=www.omg.org
OMIT="
  $INPUT/$IMCE/math
  $INPUT/$IMCE/skeleton
  $INPUT/$IMCE/discipline/mechanical
  $INPUT/$IMCE/discipline/ontological-behavior
  $INPUT/$IMCE/discipline/risk
  $INPUT/$IMCE/discipline/state-analysis
  $INPUT/$IMCE/foundation/owl2-mof2
  $INPUT/$IMCE/foundation/time
  $INPUT/$IMCE/$OMG_ORG
  $INPUT/$IMCE/*/*/*-embedding.oml
"
EUROPA_OML="$INPUT/$EUROPA/projects/EuropaClipper/DesignCapture/vocabularyExtensions/EuropaPersonnel/europa.oml"
W3_ORG=www.w3.org

# run in analysis target/workflow/artifacts

if [ $(expr "$PWD" : '.*target\/workflow\/artifacts$') -eq 0 ]
then
  echo "must run in .../target/workflow/artifacts" 1>&2
  exit 1
fi

# locate export zip

input=$1
if [ -f "$input" ]
then
  case "$input" in
    *.zip)    ;;
    *)	      echo "input must be a zip file" 1>&2
	      exit 1;;
  esac
else
  echo "no export zip file $input" 1>&2
  exit 1
fi

# unzip exporter data

rm -rf $INPUT
unzip $input -d $INPUT

# purge omitted IMCE ontologies

rm -rf $OMIT

# remove bogus vocabulary extension in europa.oml

sed '/extends.*owl2-mof2/d' $EUROPA_OML > /tmp/europa_oml_$$
mv /tmp/europa_oml_$$ $EUROPA_OML

# use latest w3.org and purl.org OML files

rsync -a --delete $PUBLIC_OML/$W3_ORG/ $INPUT/$W3_ORG
rsync -a --delete $PUBLIC_OML/$PURL_ORG/ $INPUT/$PURL_ORG

# convert OML to owl

$CONVERT text --cat $INPUT/$CATALOG --output $OUTPUT --owl --clear

# add purl.org ontologies not created by converter

rsync -a $PURL_ORG_OWL $OUTPUT

# add cached project bundle

rsync -av --exclude='**-embedding*' $PUBLIC_BUNDLES/$PROJECT_BUNDLE_PATH/ $OUTPUT/$PROJECT_BUNDLE_PATH
